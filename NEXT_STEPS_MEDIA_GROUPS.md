# –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø

## –¶–µ–ª—å
–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å **–≤—Å–µ** —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å—Ç–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ.

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚úÖ –û–¥–Ω–æ —Ñ–æ—Ç–æ - —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –û–¥–Ω–æ –≤–∏–¥–µ–æ - —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚ö†Ô∏è –ù–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ - –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ  
‚ö†Ô∏è –§–æ—Ç–æ + –≤–∏–¥–µ–æ - –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ  

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (5 –º–∏–Ω)

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å `Post`:**

```python
# src/cars_bot/database/models/post.py

media_group_id: Mapped[Optional[int]] = mapped_column(
    Integer,
    nullable=True,
    comment="Telegram grouped_id for media groups (albums)"
)

message_ids: Mapped[Optional[list[int]]] = mapped_column(
    JSON,
    nullable=True,
    comment="List of message_id for media group messages"
)
```

**–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
```bash
cd "/Users/edgark/CARS BOT"
source venv/bin/activate
alembic revision --autogenerate -m "add_media_group_support"
alembic upgrade head
```

### –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–∏—Ç—å Monitor (15 –º–∏–Ω)

**–§–∞–π–ª**: `src/cars_bot/monitor/message_processor.py`

**–ó–∞–¥–∞—á–∏:**
1. –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å `grouped_id` –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
2. –°–æ–±–∏—Ä–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º `grouped_id`
3. –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Å–µ `message_id` –≤ –ë–î

**–ü—Å–µ–≤–¥–æ–∫–æ–¥:**
```python
# –í –∫–ª–∞—Å—Å–µ MessageProcessor
self.pending_groups = {}  # {grouped_id: [messages]}

async def process_message(self, message):
    if message.grouped_id:
        # –î–æ–±–∞–≤–∏—Ç—å –≤ –±—É—Ñ–µ—Ä
        if message.grouped_id not in self.pending_groups:
            self.pending_groups[message.grouped_id] = []
        self.pending_groups[message.grouped_id].append(message)
        
        # –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å—é –≥—Ä—É–ø–ø—É
        await asyncio.sleep(2)
        
        if message.grouped_id in self.pending_groups:
            messages = self.pending_groups.pop(message.grouped_id)
            await self._process_media_group(messages, channel)
    else:
        # –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await self._process_single_message(message, channel)
```

### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–∏—Ç—å Publishing Service (20 –º–∏–Ω)

**–§–∞–π–ª**: `src/cars_bot/publishing/service.py`

**–í–∞—Ä–∏–∞–Ω—Ç A: –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
```python
if post.media_group_id and post.message_ids:
    # –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã
    for msg_id in post.message_ids:
        await self.bot.copy_message(
            chat_id=self.channel_id,
            from_chat_id=source_chat_id,
            message_id=msg_id
        )
        # –£–¥–∞–ª–∏—Ç—å caption
        await self.bot.edit_message_caption(...)
    
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –º–µ–¥–∏–∞
    await self.bot.send_message(text=caption, reply_markup=keyboard)
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –°–∫–∞—á–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ send_media_group (—Å–ª–æ–∂–Ω–µ–µ)**
```python
# –°–∫–∞—á–∞—Ç—å –≤—Å–µ –º–µ–¥–∏–∞
media_group = []
for msg_id in post.message_ids:
    # –ü–æ–ª—É—á–∏—Ç—å –º–µ–¥–∏–∞
    file = await self.bot.get_file(file_id)
    # –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É
    media_group.append(InputMediaPhoto(...))

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É —Å –Ω–∞—à–∏–º caption
await self.bot.send_media_group(
    chat_id=self.channel_id,
    media=media_group
)
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥: –í–∞—Ä–∏–∞–Ω—Ç A

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –º–µ–¥–∏–∞
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ —Ç–∏–ø–∞–º–∏ –º–µ–¥–∏–∞

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ú–µ–¥–∏–∞ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –Ω–µ –∫–∞–∫ –∞–ª—å–±–æ–º
- ‚ö†Ô∏è –ú–µ–∂–¥—É –º–µ–¥–∏–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

## –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

| –≠—Ç–∞–ø | –í—Ä–µ–º—è | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|------|-------|-----------|
| –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î | 5 –º–∏–Ω | –õ–µ–≥–∫–æ |
| Monitor | 15 –º–∏–Ω | –°—Ä–µ–¥–Ω–µ |
| Publishing | 20 –º–∏–Ω | –°—Ä–µ–¥–Ω–µ |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 10 –º–∏–Ω | –õ–µ–≥–∫–æ |
| **–ò–¢–û–ì–û** | **50 –º–∏–Ω** | |

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **2 —Ñ–æ—Ç–æ**: –î–æ–ª–∂–Ω—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è –æ–±–∞
2. **5 —Ñ–æ—Ç–æ**: –î–æ–ª–∂–Ω—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è –≤—Å–µ 5
3. **–í–∏–¥–µ–æ + 3 —Ñ–æ—Ç–æ**: –î–æ–ª–∂–Ω—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è –≤—Å–µ
4. **1 —Ñ–æ—Ç–æ**: –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–æ–ª–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –º–æ–∂–Ω–æ:

1. –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –ø–µ—Ä–≤–æ–µ –º–µ–¥–∏–∞)
2. –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–ø–∏—Å–∞–Ω–∏–µ: "–ë–æ–ª—å—à–µ —Ñ–æ—Ç–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –ø–æ—Å—Ç–µ" —Å —Å—Å—ã–ª–∫–æ–π
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–∑–∂–µ

```python
# –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ
if post.media_group_id:
    # –ü—É–±–ª–∏–∫—É–µ–º –ø–µ—Ä–≤–æ–µ –º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç
    caption += f"\n\nüì∏ –ë–æ–ª—å—à–µ —Ñ–æ—Ç–æ: {post.original_message_link}"
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç

üü¢ **–†–µ–∫–æ–º–µ–Ω–¥—É—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å** - —ç—Ç–æ –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤, –≥–¥–µ –æ–±—ã—á–Ω–æ –º–Ω–æ–≥–æ —Ñ–æ—Ç–æ.

–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é? –°–∫–∞–∂–∏—Ç–µ –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—Ç—å!

