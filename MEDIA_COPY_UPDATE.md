# Обновление: Копирование медиафайлов и упрощение генерации

## Проблемы, которые были решены

1. ❌ **Бот не копировал медиафайлы** при публикации постов
2. ❌ **AI генерировал слишком длинные описания** (919 символов вместо краткой структуризации)

## Изменения

### 1. Добавлено поле для хранения медиафайлов

**Файл:** `src/cars_bot/database/models/post.py`
- Добавлено поле `media_files: Optional[list[str]]` для хранения списка file_id медиафайлов
- Применена миграция БД

### 2. Обновлен процессор сообщений

**Файл:** `src/cars_bot/monitor/message_processor.py`
- `MediaInfo` теперь включает `file_ids: list[str]`
- `_extract_media_info()` извлекает photo ID и access_hash из Telethon сообщений
- `_save_to_database()` сохраняет media_files в Post

### 3. Обновлен сервис публикации

**Файл:** `src/cars_bot/publishing/service.py`
- Добавлен новый метод `_copy_original_message_with_text()`
- Использует Telegram API `copy_message` для копирования оригинального сообщения с медиафайлами
- Заменяет текст на новый отформатированный
- Автоматический fallback на text-only если копирование не удалось

### 4. Упрощены промпты AI генерации

**Файл:** `src/cars_bot/ai/prompts.py`

**Было:**
- Длинные описания (100-500 слов)
- Множество абзацев с подробностями
- Результат: 919 символов

**Стало:**
- Краткое структурирование (50-100 слов)
- Только факты из оригинала
- НЕ добавляется лишняя информация
- Минималистичный стиль

**Пример результата:**
```
BMW 3 серии, 2.5л автомат. Пробег 150 тыс. км, 2 владельца, чистая автотека. 
Полная комплектация, кожаный салон, панорамная крыша.
```

## Как работает копирование медиафайлов

1. **Мониторинг получает сообщение** → сохраняет photo ID в `media_files`
2. **AI обрабатывает текст** → структурирует данные кратко
3. **Публикация** → использует `copy_message` для копирования оригинального поста с фото
4. **Результат** → пост опубликован с оригинальными медиафайлами и новым текстом

## Применение изменений

```bash
# 1. Миграция уже применена
alembic upgrade head

# 2. Перезапустите сервисы
make restart

# Или вручную:
./scripts/stop_celery.sh
./scripts/start_celery_worker.sh
./scripts/start_celery_beat.sh
./scripts/start_monitor.sh
```

## Проверка работы

После перезапуска сервисов:

1. ✅ Новые посты с фото будут публиковаться с медиафайлами
2. ✅ Описания будут краткими и структурированными
3. ✅ Не будет добавляться лишняя информация

## Технические детали

### copy_message API
- Копирует оригинальное сообщение полностью
- Позволяет заменить caption (текст)
- Сохраняет качество медиафайлов
- Работает между каналами

### Fallback механизм
Если `copy_message` не удалось:
1. Пробует опубликовать text-only
2. Логирует ошибку
3. Пост всё равно публикуется (без фото)

## Примечания

- Медиафайлы копируются только для новых постов
- Старые посты (без media_files) будут публиковаться без фото
- Bot должен иметь доступ к исходному каналу для копирования

