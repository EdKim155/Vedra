# ‚úÖ –û–¢–ß–ï–¢ –û–ë –£–°–¢–†–ê–ù–ï–ù–ò–ò –ü–†–û–ë–õ–ï–ú –ù–ê –°–ï–†–í–ï–†–ï

**–î–∞—Ç–∞**: 27 –æ–∫—Ç—è–±—Ä—è 2025, 17:10 UTC  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–û–°–ù–û–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –£–°–¢–†–ê–ù–ï–ù–´**

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ):
- **Telegram Bot** - RUNNING (pid 27453) - ‚úÖ –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- **Celery Worker** - RUNNING (pid 27461) - ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏
- **Celery Beat** - RUNNING (pid 27450) - ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ):
- **Monitor** - FATAL (–ø—Ä–æ–±–ª–µ–º–∞ —Å Telegram —Å–µ—Å—Å–∏–µ–π)
- **Webhook** - FATAL (–º–æ–¥—É–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

---

## üîç –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. ‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Celery (–ò–°–ü–†–ê–í–õ–ï–ù–û)

**–ë—ã–ª–æ**: ~10+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Celery Worker –∏ 2 Celery Beat  
**–ü—Ä–∏—á–∏–Ω–∞**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–≤ —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã  
**–†–µ—à–µ–Ω–∏–µ**: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Supervisor

### 2. ‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ò–°–ü–†–ê–í–õ–ï–ù–û)

**–ë—ã–ª–æ**: ValidationError - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ —á–∏—Ç–∞–ª–∏—Å—å  
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ Supervisor  
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–æ–≥–ª–∞—Å–Ω–æ Pydantic Settings:
- `TELEGRAM__BOT_TOKEN` ‚Üí `BOT__TOKEN`
- `NEWS_CHANNEL_ID` ‚Üí `BOT__NEWS_CHANNEL_ID`
- `GOOGLE_SHEETS_ID` ‚Üí `GOOGLE__SPREADSHEET_ID`
- `GOOGLE_SERVICE_ACCOUNT_FILE` ‚Üí `GOOGLE__CREDENTIALS_FILE`
- `AI__OPENAI_API_KEY` ‚Üí `OPENAI_API_KEY`

### 3. ‚ö†Ô∏è Watchdog –º–æ–Ω–∏—Ç–æ—Ä–∞ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π (–ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –∫–æ–¥–µ)

**–ë—ã–ª–æ**: –ú–æ–Ω–∏—Ç–æ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è –∫–∞–∂–¥—ã–µ 5-15 –º–∏–Ω—É—Ç  
**–ü—Ä–∏—á–∏–Ω–∞**: `max_idle_time = 60` —Å–µ–∫—É–Ω–¥ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ  
**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ `max_idle_time = 300` (5 –º–∏–Ω—É—Ç)

### 4. ‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç Telegram Bot (–£–°–¢–†–ê–ù–ï–ù–û)

**–ë—ã–ª–æ**: TelegramConflictError - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –±–æ—Ç–∞  
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—ã—Ç–∞–ª–∏—Å—å –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è  
**–†–µ—à–µ–Ω–∏–µ**: –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å —á–µ—Ä–µ–∑ Supervisor

---

## üîß –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø

### –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ 15+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 3-5)
‚úÖ –ù–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã Celery Worker –∏ Beat
‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã Telegram Bot
```

### –®–∞–≥ 2: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
```bash
‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–Ω–µ –∑–∞–ø—É—â–µ–Ω—ã)
‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Supervisor —Å–µ—Ä–≤–∏—Å—ã
‚úÖ –£–±–∏—Ç—ã –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supervisor
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–¥ –º–æ–Ω–∏—Ç–æ—Ä–∞ (watchdog timeout)
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ—Å—Å–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supervisor
‚úÖ –ó–∞–ø—É—â–µ–Ω—ã —Å–µ—Ä–≤–∏—Å—ã
‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
```

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### –ü—Ä–æ—Ü–µ—Å—Å—ã
```
root     27450  - Celery Beat       (1 –ø—Ä–æ—Ü–µ—Å—Å) ‚úÖ
root     27453  - Telegram Bot      (1 –ø—Ä–æ—Ü–µ—Å—Å) ‚úÖ
root     27461+ - Celery Worker     (1 –≥–ª–∞–≤–Ω—ã–π + 4 –¥–æ—á–µ—Ä–Ω–∏—Ö) ‚úÖ
```

**–ò—Ç–æ–≥–æ**: 6 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)

### –õ–æ–≥–∏
```
Bot log (17:09:53):
‚úÖ Cars Bot is running!
‚úÖ Run polling for bot @Vedrro_bot id=8355579123

Celery Worker:
‚úÖ RUNNING - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏

Celery Beat:
‚úÖ RUNNING - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
```

---

## ‚úÖ –ß–¢–û –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–ï–¢

### Telegram Bot
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã `/start`, `/help`, `/subscription`
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ TelegramConflictError
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ YooKassa
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏

### Celery Tasks
- ‚úÖ AI –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤ (—á–µ—Ä–µ–∑ OpenAI)
- ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –≤ –∫–∞–Ω–∞–ª
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –°–±–æ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã

---

## ‚ö†Ô∏è –ß–¢–û –¢–†–ï–ë–£–ï–¢ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ì–û –í–ù–ò–ú–ê–ù–ò–Ø

### 1. Monitor (FATAL)

**–ü—Ä–æ–±–ª–µ–º–∞**: 
```
AuthKeyDuplicatedError: The authorization key (session file) was used 
under two different IP addresses simultaneously
```

**–ü—Ä–∏—á–∏–Ω–∞**: –°–µ—Å—Å–∏—è Telegram –±—ã–ª–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ** (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é):
1. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   ```bash
   ssh carsbot
   cd /root/cars-bot
   rm sessions/monitor_session.session*
   python scripts/create_session.py
   # –í–≤–µ—Å—Ç–∏ phone, code, password
   supervisorctl restart carsbot:cars-monitor
   ```

### 2. Webhook (FATAL)

**–ü—Ä–æ–±–ª–µ–º–∞**:
```
ModuleNotFoundError: No module named 'cars_bot.webhook'
```

**–ü—Ä–∏—á–∏–Ω–∞**: –ú–æ–¥—É–ª—å `cars_bot.webhook.server` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ `run_webhook.py`:
- –£–∂–µ –∑–∞–ø—É—â–µ–Ω (PID 10838)
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://127.0.0.1:8080
- Supervisor –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É

**–î–µ–π—Å—Ç–≤–∏–µ**: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å webhook:
```bash
ssh carsbot
supervisorctl restart carsbot:cars-webhook
```

---

## üìù –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
```bash
ssh carsbot
supervisorctl status carsbot:*
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
ssh carsbot
tail -f /root/cars-bot/logs/bot_output.log
tail -f /root/cars-bot/logs/celery_worker_output.log
```

### –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
```
Telegram: @Vedrro_bot
–ö–æ–º–∞–Ω–¥–∞: /start
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
```bash
ssh carsbot
grep "TelegramConflictError" /root/cars-bot/logs/bot_output.log
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
```

---

## üéâ –ò–¢–û–ì–û

### ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ:
1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Celery - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
2. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã Telegram Bot - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä
3. –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö - –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. Celery Worker –∑–∞–≤–µ—Ä—à–∞–ª—Å—è - —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

### ‚è≥ –û—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ):
1. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é Monitor –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Webhook —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

### üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–î–æ**: 15+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –ø–∞–¥–µ–Ω–∏—è
- **–ü–æ—Å–ª–µ**: 6 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –§–ê–ô–õ–´

–°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- `DIAGNOSIS_AND_FIX.md` - –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- `supervisor_config.conf` - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `SERVER_FIX_INSTRUCTIONS.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- `fix_server.sh` - –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `deploy_fix_to_server.sh` - –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ:
- `src/cars_bot/monitor/monitor.py` - –£–≤–µ–ª–∏—á–µ–Ω watchdog timeout

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~15 –º–∏–Ω—É—Ç  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é Monitor (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)  
**–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã**: ‚úÖ **–ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï**

