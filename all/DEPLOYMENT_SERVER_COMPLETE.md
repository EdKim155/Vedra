# ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Cars Bot –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ - –ó–ê–í–ï–†–®–ï–ù–û

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Python 3.12
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω PostgreSQL 16
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Redis
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Nginx
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Supervisor –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `cars_bot`
- ‚úÖ –°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `cars_bot_user`
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (10 —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω–æ)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `payments` –¥–ª—è YooKassa

### 3. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä (`/root/cars-bot`)
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω `.env` —Ñ–∞–π–ª
- ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Google Sheets
- ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å–µ—Å—Å–∏–∏ Telegram

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è YooKassa
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `Payment` –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `YooKassaPaymentService`
- ‚úÖ –°–æ–∑–¥–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤ `YooKassaWebhookHandler`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –±–æ—Ç–µ
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ü–µ–Ω—ã: 190‚ÇΩ/–º–µ—Å—è—Ü, 1990‚ÇΩ/–≥–æ–¥

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–º–µ–Ω–∞ `formygooglesheet.ru`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–æ–∫—Å–∏ –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤ `/webhooks/yookassa`
- ‚úÖ Nginx –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supervisor
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
  - `cars-bot` - –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç
  - `cars-monitor` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤
  - `cars-celery-worker` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
  - `cars-celery-beat` - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
  - `cars-webhook` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤ YooKassa
- ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```
–•–æ—Å—Ç: localhost
–ü–æ—Ä—Ç: 5432
–ë–∞–∑–∞: cars_bot
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: cars_bot_user
–ü–∞—Ä–æ–ª—å: CarsBot2025Pass
```

### –í–µ–±—Ö—É–∫–∏ YooKassa
```
URL: https://formygooglesheet.ru/webhooks/yookassa
–ü–æ—Ä—Ç (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π): 8080
–°–æ–±—ã—Ç–∏—è:
  - payment.succeeded
  - payment.waiting_for_capture
  - payment.canceled
  - refund.succeeded
```

### –¶–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫
```
–ú–µ—Å—è—á–Ω–∞—è: 190‚ÇΩ
–ì–æ–¥–æ–≤–∞—è: 1990‚ÇΩ
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```
/root/cars-bot/
‚îú‚îÄ‚îÄ .env                    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ alembic/               # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ logs/                  # –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ secrets/               # service_account.json
‚îú‚îÄ‚îÄ sessions/              # Telegram —Å–µ—Å—Å–∏–∏
‚îú‚îÄ‚îÄ src/                   # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îú‚îÄ‚îÄ venv/                  # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
‚îî‚îÄ‚îÄ requirements.txt       # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
supervisorctl status
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
```bash
supervisorctl restart carsbot:cars-bot
supervisorctl restart carsbot:cars-monitor
supervisorctl restart carsbot:cars-celery-worker
supervisorctl restart carsbot:cars-celery-beat
supervisorctl restart carsbot:cars-webhook
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
supervisorctl restart carsbot:*
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
tail -f /root/cars-bot/logs/bot_output.log
tail -f /root/cars-bot/logs/monitor_output.log
tail -f /root/cars-bot/logs/celery_worker_output.log
tail -f /root/cars-bot/logs/celery_beat_output.log
tail -f /root/cars-bot/logs/webhook_output.log
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
supervisorctl stop carsbot:*
```

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
supervisorctl start carsbot:*
```

## üîê SSH –¥–æ—Å—Ç—É–ø

```bash
ssh carsbot
```

–ù–∞—Å—Ç—Ä–æ–µ–Ω SSH-–∫–ª—é—á –¥–ª—è –±–µ–∑–ø–∞—Ä–æ–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ YooKassa

–í–µ–±—Ö—É–∫–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —á–µ—Ä–µ–∑ Nginx. –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤ –ø–∞–Ω–µ–ª–∏ YooKassa:

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
3. –î–æ–±–∞–≤—å—Ç–µ URL: `https://formygooglesheet.ru/webhooks/yookassa`
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded` - –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
   - ‚úÖ `payment.waiting_for_capture` - –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   - ‚úÖ `payment.canceled` - –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
   - ‚úÖ `refund.succeeded` - –£—Å–ø–µ—à–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –±–æ—Ç—É –≤ Telegram
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f /root/cars-bot/logs/bot_output.log`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
ssh carsbot
sudo -u postgres psql -d cars_bot -c "\dt"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
```bash
redis-cli ping
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±—Ö—É–∫–∞
```bash
curl -X POST http://127.0.0.1:8080/webhooks/yookassa \
  -H "Content-Type: application/json" \
  -d '{}'
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh carsbot

# 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /root/cars-bot

# 3. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ (—á–µ—Ä–µ–∑ git pull –∏–ª–∏ scp)
# –ù–∞–ø—Ä–∏–º–µ—Ä:
# scp -r /path/to/local/src/* carsbot:/root/cars-bot/src/

# 4. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate

# 5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
pip install -r requirements.txt

# 6. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ–º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
export DATABASE__URL='postgresql+asyncpg://cars_bot_user:CarsBot2025Pass@localhost:5432/cars_bot'
alembic upgrade head

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã
supervisorctl restart carsbot:*
```

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–∞—Ä–æ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å `CarsBot2025Pass` –Ω–∞ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
2. **HTTPS**: –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSL (Let's Encrypt)
3. **Backup**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Prometheus + Grafana –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. **Firewall**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç—ã 80, 443, 22 –æ—Ç–∫—Ä—ã—Ç—ã, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç—ã

## üéâ –ì–æ—Ç–æ–≤–æ!

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç. –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ YooKassa.

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 27 –æ–∫—Ç—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

