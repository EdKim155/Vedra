# Ручное управление подписками через Google Sheets

## Обзор

Система позволяет администратору вручную управлять подписками пользователей через Google Sheets **без необходимости оплаты**. Это полезно для:

- Выдачи пробных подписок
- Компенсации за проблемы
- Награждения активных пользователей
- Тестирования функциональности

## Как это работает

### Автоматическая синхронизация

Система автоматически синхронизирует данные **каждые 2 минуты**:
1. **БД → Google Sheets**: Обновляет информацию о подписках пользователей (каждые 5 минут)
2. **Google Sheets → БД**: Читает изменения из таблицы и применяет их (каждые 2 минуты)

### Автоматический расчет дат

При изменении типа подписки система **автоматически рассчитывает** даты:
- **Дата начала**: Устанавливается текущая дата/время (если не указана)
- **Дата окончания**: Рассчитывается на основе типа подписки:
  - `FREE`: Бесплатная подписка (бессрочно)
  - `MONTHLY`: +30 дней от даты начала
  - `YEARLY`: +365 дней от даты начала

## Инструкция по использованию

### 1. Откройте таблицу "Подписчики"

Перейдите в Google Sheets и откройте лист **"Подписчики"**.

### 2. Найдите пользователя

Найдите строку с нужным пользователем по:
- **User ID** (Telegram user ID)
- **Username** (@username)
- **Имя** (имя пользователя)

### 3. Измените тип подписки

В столбце **"Тип подписки"** (D) выберите из выпадающего списка:
- `FREE` - бесплатная подписка
- `MONTHLY` - месячная подписка (30 дней)
- `YEARLY` - годовая подписка (365 дней)

### 4. Проверьте статус активности

Убедитесь, что столбец **"Активна"** (E) имеет значение `TRUE`.

### 5. Даты обновятся автоматически

В течение **2 минут** система автоматически:
- Обновит подписку в базе данных
- Рассчитает и заполнит **"Дата начала"** (F)
- Рассчитает и заполнит **"Дата окончания"** (G)

### 6. Проверьте результат

Через 2-3 минуты обновите таблицу и убедитесь, что:
- Даты заполнены автоматически
- Пользователь получил доступ к функциям подписки

## Примеры использования

### Пример 1: Выдать месячную подписку

**До изменения:**
```
User ID   | Username | Имя         | Тип    | Активна | Дата начала | Дата окончания
123456789 | @user1   | Иван Иванов | FREE   | TRUE    |             |
```

**Действия:**
1. Измените `FREE` на `MONTHLY` в столбце D
2. Подождите 2 минуты

**После синхронизации:**
```
User ID   | Username | Имя         | Тип     | Активна | Дата начала       | Дата окончания
123456789 | @user1   | Иван Иванов | MONTHLY | TRUE    | 2025-10-27 10:30:00 | 2025-11-26 10:30:00
```

### Пример 2: Выдать годовую подписку

**До изменения:**
```
User ID   | Username | Имя          | Тип    | Активна | Дата начала | Дата окончания
987654321 | @user2   | Петр Петров  | FREE   | TRUE    |             |
```

**Действия:**
1. Измените `FREE` на `YEARLY` в столбце D
2. Подождите 2 минуты

**После синхронизации:**
```
User ID   | Username | Имя          | Тип    | Активна | Дата начала       | Дата окончания
987654321 | @user2   | Петр Петров  | YEARLY | TRUE    | 2025-10-27 10:30:00 | 2026-10-27 10:30:00
```

### Пример 3: Продлить существующую подписку

**Текущее состояние:**
```
User ID   | Username | Имя          | Тип     | Активна | Дата начала       | Дата окончания
555555555 | @user3   | Мария        | MONTHLY | TRUE    | 2025-10-01 00:00:00 | 2025-10-31 00:00:00
```

**Действия:**
1. Измените тип на `YEARLY`
2. Подождите 2 минуты

**После синхронизации:**
```
User ID   | Username | Имя          | Тип    | Активна | Дата начала       | Дата окончания
555555555 | @user3   | Мария        | YEARLY | TRUE    | 2025-10-27 10:30:00 | 2026-10-27 10:30:00
```

> ⚠️ **Примечание**: При изменении типа подписки дата начала сбрасывается на текущую дату!

### Пример 4: Деактивировать подписку

**Текущее состояние:**
```
User ID   | Username | Имя          | Тип     | Активна | Дата начала       | Дата окончания
777777777 | @user4   | Алексей      | MONTHLY | TRUE    | 2025-10-01 00:00:00 | 2025-10-31 00:00:00
```

**Действия:**
1. Измените `TRUE` на `FALSE` в столбце E
2. Подождите 2 минуты

**Результат:**
- Подписка деактивируется в базе данных
- Пользователь потеряет доступ к платным функциям

## Ручное указание дат

Если нужно указать **конкретные даты**, заполните их вручную:

### Формат дат
```
YYYY-MM-DD HH:MM:SS
```

### Пример с ручными датами

**Действия:**
1. Установите тип подписки: `MONTHLY`
2. Вручную заполните **"Дата начала"**: `2025-11-01 00:00:00`
3. Вручную заполните **"Дата окончания"**: `2025-12-01 00:00:00`
4. Подождите 2 минуты

**Результат:**
- Система применит указанные даты
- Подписка будет активна с 1 ноября по 1 декабря

## Структура столбцов

| Столбец | Название | Тип | Описание | Пример |
|---------|----------|-----|----------|---------|
| A | User ID | Integer | Telegram user ID (не изменять!) | 123456789 |
| B | Username | String | Telegram username | @user1 |
| C | Имя | String | Имя пользователя | Иван Иванов |
| D | Тип подписки | Enum | FREE / MONTHLY / YEARLY | MONTHLY |
| E | Активна | Boolean | TRUE / FALSE | TRUE |
| F | Дата начала | DateTime | Дата начала подписки (авто) | 2025-10-27 10:30:00 |
| G | Дата окончания | DateTime | Дата окончания подписки (авто) | 2025-11-26 10:30:00 |
| H | Дата регистрации | DateTime | Дата регистрации в боте | 2025-10-20 15:00:00 |
| I | Запросов контактов | Integer | Количество запросов (авто) | 5 |

## Важные замечания

### ⚠️ Что НЕ делать:

1. **НЕ изменяйте User ID** - это идентификатор пользователя
2. **НЕ удаляйте строки** - это приведет к рассинхронизации
3. **НЕ создавайте новые строки вручную** - пользователи создаются автоматически при регистрации
4. **НЕ используйте неправильный формат дат** - система может не распознать их

### ✅ Что можно делать:

1. ✅ Изменять тип подписки (FREE/MONTHLY/YEARLY)
2. ✅ Активировать/деактивировать подписки (TRUE/FALSE)
3. ✅ Вручную указывать даты начала и окончания
4. ✅ Изменять имя пользователя для удобства

## Мониторинг

### Проверка синхронизации

Проверить статус синхронизации можно через:
```bash
# Посмотреть логи Celery Beat
tail -f logs/celery_beat.log | grep sync_subscriptions_from_sheets

# Проверить статус задач
python -c "from cars_bot.celery_app import inspect_celery; print(inspect_celery())"
```

### Ручной запуск синхронизации

Если нужно синхронизировать немедленно:
```bash
# Запустить задачу вручную
python -c "from cars_bot.tasks.sheets_tasks import sync_subscriptions_from_sheets_task; sync_subscriptions_from_sheets_task.delay()"
```

## Частые вопросы

### Q: Как быстро применяются изменения?
**A**: Максимум 2 минуты. Задача синхронизации запускается каждые 2 минуты.

### Q: Что если я укажу некорректные даты?
**A**: Система попытается распарсить даты. Если не получится, будут использованы автоматически рассчитанные даты.

### Q: Можно ли отменить изменения?
**A**: Да, просто верните старые значения в таблице и подождите 2 минуты.

### Q: Получит ли пользователь уведомление об изменении подписки?
**A**: Нет, изменения применяются автоматически без уведомлений. Пользователь увидит изменения при следующем использовании бота.

### Q: Как проверить, что изменения применились?
**A**: 
1. Обновите таблицу через 2-3 минуты
2. Проверьте, что даты заполнены
3. Проверьте логи: `tail -f logs/celery_worker.log`

### Q: Можно ли выдать подписку пользователю, который еще не зарегистрировался?
**A**: Нет. Пользователь должен сначала начать работу сботом (нажать /start).

## Техническая информация

### Celery Task
- **Задача**: `cars_bot.tasks.sheets_tasks.sync_subscriptions_from_sheets_task`
- **Периодичность**: Каждые 2 минуты
- **Очередь**: `sheets_sync`
- **Приоритет**: 3 (высокий)

### Методы API
- `GoogleSheetsManager.get_subscribers()` - читает подписчиков из таблицы
- `SubscriptionManager.apply_subscription_from_sheets()` - применяет изменения к БД
- `GoogleSheetsManager.update_subscriber_status()` - обновляет данные в таблице

### Логика расчета дат

```python
# Для MONTHLY
end_date = start_date + 30 дней

# Для YEARLY  
end_date = start_date + 365 дней

# Для FREE
end_date = start_date + 100 лет (бессрочно)
```

## Поддержка

При возникновении проблем:
1. Проверьте логи Celery
2. Убедитесь, что задача `sync_subscriptions_from_sheets_task` запущена
3. Проверьте подключение к Google Sheets API
4. Проверьте права доступа сервисного аккаунта

---

**Последнее обновление**: 27 октября 2025  
**Версия**: 1.0


