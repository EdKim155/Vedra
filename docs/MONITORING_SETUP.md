# Telegram Channel Monitoring Setup Guide

## Обзор

Система мониторинга каналов использует Telegram User Session (не Bot API) для отслеживания новых сообщений в указанных каналах. Это позволяет:

- Мониторить как публичные, так и приватные каналы
- Получать сообщения в реальном времени
- Избежать ограничений Bot API
- Иметь доступ ко всем медиа-файлам

## Требования

1. **Telegram аккаунт** (желательно отдельный, не личный)
2. **API credentials** от Telegram
3. **PostgreSQL** база данных
4. **Python 3.11+**

## Пошаговая Настройка

### Шаг 1: Получение API Credentials

1. Перейдите на https://my.telegram.org
2. Войдите с помощью номера телефона
3. Перейдите в раздел **"API development tools"**
4. Создайте новое приложение:
   - **App title**: "Cars Monitor Bot" (или любое название)
   - **Short name**: "carsbot" (или уникальное имя)
   - **Platform**: Desktop (рекомендуется)
   - **Description**: описание (опционально)
5. Сохраните полученные данные:
   - **api_id** (цифры, например: 12345678)
   - **api_hash** (строка, например: 0123456789abcdef0123456789abcdef)

### Шаг 2: Настройка Environment Variables

Создайте файл `.env` в корне проекта (скопируйте из `.env.example`):

```bash
cp .env.example .env
```

Заполните следующие переменные:

```env
# Telegram User Session
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=0123456789abcdef0123456789abcdef
TELEGRAM_SESSION_NAME=monitor_session
TELEGRAM_SESSION_DIR=sessions

# Database
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/carsbot

# Other settings...
```

### Шаг 3: Создание Session File

Запустите скрипт создания сессии:

```bash
python scripts/create_session.py
```

Скрипт попросит:
1. **Номер телефона** (в международном формате: +1234567890)
2. **Код подтверждения** (придет в Telegram)
3. **2FA пароль** (если включен)

После успешной авторизации будет создан файл сессии:
- `sessions/monitor_session.session` - основной файл сессии
- `sessions/monitor_session_backup.txt` - резервная копия (string session)

### Шаг 4: Тестирование Session

Проверьте, что сессия работает:

```bash
python scripts/create_session.py test
```

Вы должны увидеть информацию о вашем аккаунте и количество доступных диалогов.

### Шаг 5: Подписка на Каналы

Аккаунт, используемый для мониторинга, должен быть подписан на все каналы, которые вы хотите отслеживать:

1. Откройте Telegram с этим аккаунтом
2. Подпишитесь на все нужные каналы
3. Для приватных каналов - получите инвайт-ссылку и присоединитесь

### Шаг 6: Добавление Каналов в Google Sheets

Откройте ваш Google Sheets и перейдите на лист **"Каналы для мониторинга"**.

Добавьте каналы в следующем формате:

| Username канала | Название канала | Активен | Ключевые слова |
|----------------|----------------|---------|----------------|
| @carsales      | Car Sales Channel | TRUE | продам,продаю,продаётся |
| @autochannel   | Auto Channel    | TRUE | автомобиль,машина,авто |

### Шаг 7: Запуск Мониторинга

Запустите сервис мониторинга:

```bash
python -m cars_bot.monitor.monitor
```

Или через docker-compose:

```bash
docker-compose up monitor
```

## Архитектура Системы

```
┌─────────────────┐
│  Telegram       │
│  Channels       │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│  ChannelMonitor             │
│  (Telethon Client)          │
│                             │
│  - Rate Limiter             │
│  - Deduplicator             │
│  - Event Handlers           │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────────────────┐
│  Message Processing         │
│                             │
│  - Keyword Filtering        │
│  - Validation               │
│  - Database Save            │
└────────┬────────────────────┘
         │
         ▼
┌─────────────────────────────┐
│  AI Processing Queue        │
│  (Future Implementation)    │
└─────────────────────────────┘
```

## Основные Компоненты

### ChannelMonitor

Главный класс для мониторинга каналов:
- Подключается к Telegram через Telethon
- Загружает список каналов из БД
- Слушает новые сообщения
- Фильтрует по ключевым словам
- Сохраняет в БД для обработки

### RateLimiter

Защита от ограничений Telegram API:
- Sliding window rate limiting
- Exponential backoff при приближении к лимитам
- Автоматический cooldown при ошибках
- Имитация человеческого поведения

### MessageDeduplicator

Предотвращение дублирования:
- In-memory хранение хешей сообщений
- Автоматическая очистка старых записей
- Защита от повторной обработки

## Rate Limiting

Система использует адаптивный rate limiting:

- **Базовая задержка**: 1 секунда между запросами
- **Максимальная задержка**: 10 секунд
- **Окно**: 20 запросов в 60 секунд
- **Экспоненциальный backoff**: увеличение задержки при высокой нагрузке

## Обработка Ошибок

### Автоматическое Переподключение

При потере соединения:
1. Попытка переподключения (5 попыток)
2. Задержка 30 секунд между попытками
3. Восстановление списка каналов
4. Продолжение мониторинга

### FloodWaitError

При получении FloodWait:
- Автоматическое ожидание указанное время
- Cooldown period для rate limiter
- Логирование события

### ChannelPrivateError

Если канал приватный и нет доступа:
- Ошибка логируется
- Канал пропускается
- Необходимо подписаться вручную

## Безопасность

### Session File Security

⚠️ **ВАЖНО**: Session файлы дают полный доступ к аккаунту!

1. **Никогда не коммитьте** session файлы в Git
2. **Храните в безопасном месте** (добавлено в .gitignore)
3. **Создайте резервные копии** (backup string session)
4. **Используйте отдельный аккаунт** (не личный)
5. **Шифруйте при хранении** в production

### Рекомендации по Аккаунту

Используйте для мониторинга:
- ✅ Отдельный аккаунт (не личный)
- ✅ Аккаунт старше 6 месяцев
- ✅ С аватаром, именем, username
- ✅ С регулярной активностью
- ❌ Не новорег
- ❌ Не использовать для спама

## Мониторинг и Логи

### Логирование

Логи сохраняются в:
- `logs/monitor_YYYY-MM-DD.log` - ежедневные логи
- Ротация: 1 день
- Хранение: 30 дней

### Метрики

В логах отслеживается:
- Количество обработанных сообщений
- Rate limiting статистика
- Ошибки и переподключения
- Производительность

### Просмотр Логов

```bash
# Последние сообщения
tail -f logs/monitor_$(date +%Y-%m-%d).log

# Поиск ошибок
grep "ERROR" logs/monitor_*.log

# Статистика сообщений
grep "New message" logs/monitor_*.log | wc -l
```

## Обновление Списка Каналов

Система автоматически обновляет список каналов каждые 60 секунд:
1. Загружает активные каналы из БД
2. Добавляет новые каналы
3. Удаляет деактивированные
4. Не требует перезапуска

Для немедленного обновления - просто измените данные в Google Sheets.

## Troubleshooting

### Session Not Authorized

```
RuntimeError: Session is not authorized
```

**Решение**: Запустите `python scripts/create_session.py`

### Channel Private Error

```
ChannelPrivateError: The channel specified is private
```

**Решение**: Подпишитесь на канал с аккаунта мониторинга

### Flood Wait

```
FloodWaitError: A wait of X seconds is required
```

**Решение**: Система автоматически ждет. Если часто - увеличьте `MONITOR_RATE_LIMIT_DELAY`

### Connection Lost

```
ConnectionError: Connection to Telegram lost
```

**Решение**: Система автоматически переподключится. Проверьте интернет-соединение.

### Invalid API Credentials

```
ApiIdInvalidError: The api_id/api_hash combination is invalid
```

**Решение**: Проверьте `TELEGRAM_API_ID` и `TELEGRAM_API_HASH` в .env

## Performance Tips

1. **Оптимальное количество каналов**: 10-50
2. **Ключевые слова**: Используйте специфичные слова для фильтрации
3. **Rate limit delay**: Увеличьте при большом количестве каналов
4. **Database**: Используйте PostgreSQL с индексами
5. **Resources**: Минимум 2GB RAM, 2 CPU cores

## API Лимиты Telegram

Telegram User API имеет следующие лимиты:
- **Запросы**: ~20 запросов в минуту
- **Сообщения**: ~30 сообщений в секунду
- **Подписки**: Практически безлимитно

При превышении лимитов получите FloodWaitError с временем ожидания.

## Дополнительные Ресурсы

- [Telethon Documentation](https://docs.telethon.dev/)
- [Telegram API](https://core.telegram.org/api)
- [My Telegram Apps](https://my.telegram.org/apps)

## FAQ

### Q: Можно ли использовать несколько аккаунтов?
A: Да, создайте несколько session файлов и запустите несколько экземпляров монитора.

### Q: Как обновить session при смене пароля?
A: Удалите старый session файл и запустите `create_session.py` снова.

### Q: Можно ли мониторить группы (не каналы)?
A: Да, Telethon поддерживает мониторинг групп и супергрупп.

### Q: Влияет ли мониторинг на работу моего аккаунта?
A: Нет, если соблюдаете rate limits и используете отдельный аккаунт.

### Q: Что делать при бане аккаунта?
A: Используйте другой аккаунт, соблюдайте рекомендации по безопасности.

---

**Версия**: 1.0  
**Дата**: 2024-10-23  
**Автор**: Cars Bot Team


