# Исправление публикации постов с видео

## Проблема

Посты с видео не публиковались, потому что для одиночных сообщений (не в медиа-группе) не сохранялся `message_ids`.

## Корневая причина

В `message_processor.py` метод `process_message`:
- ✅ Для медиа-групп (grouped_id) - `message_ids` сохранялись правильно
- ❌ Для одиночных сообщений (без grouped_id) - `message_ids` НЕ передавались в `_save_to_database`

Без `message_ids` метод `copy_messages` не может скопировать сообщение из исходного канала.

## Решение

### 1. Исправлен `message_processor.py`

**Файл:** `src/cars_bot/monitor/message_processor.py` (строка 313-319)

```python
# Было:
post = await self._save_to_database(validated_data, channel, session)

# Стало:
post = await self._save_to_database(
    validated_data, 
    channel, 
    session,
    message_ids=[message.id]  # Single message as array
)
```

**Результат:** Теперь все новые посты (фото, видео, документы) сохраняются с `message_ids`.

### 2. Созданы скрипты для исправления старых постов

**Скрипт 1:** `scripts/fix_old_posts_message_ids.py`
- Находит старые посты без `message_ids`
- Добавляет `message_ids = [original_message_id]`
- Исправлено 16 постов

**Скрипт 2:** `scripts/check_video_posts.py`
- Проверяет посты с видео в базе
- Показывает какие посты готовы к публикации

**Скрипт 3:** `scripts/check_specific_posts.py`
- Проверяет конкретные посты по ID
- Показывает детали `message_ids`

## Что было исправлено

### Статистика исправления:
```bash
# Первый запуск
✅ Fixed 14 posts!

# Второй запуск (после исправления условия)
✅ Fixed 2 posts! (Post 38 и 39)

Итого: 16 постов исправлено
```

### Посты готовые к публикации:

**Post 38:** Одиночное видео
- message_ids: [255]
- Is selling: True
- Published: False ← можно опубликовать

**Post 35:** Медиа-группа (2 фото + 1 видео)
- message_ids: [218, 219, 220, 221, 222]
- Is selling: True
- Published: False ← можно опубликовать

## Применение изменений

### 1. Перезапустить монитор:
```bash
# Остановить текущий монитор
pkill -f check_monitor.py

# Запустить заново
cd "/Users/edgark/CARS BOT"
python check_monitor.py &
```

Или в tmux:
```bash
# В терминале с монитором
Ctrl+C  # Остановить
python check_monitor.py  # Запустить заново
```

### 2. Celery worker уже работает (не требует перезапуска)

### 3. Проверка работы:
```bash
# Проверить новые посты
source venv/bin/activate
source scripts/export_env.sh
python scripts/check_video_posts.py
```

## Как это работает сейчас

### Для одиночного видео:
```
1. Монитор получает сообщение с видео
   ↓
2. MessageProcessor сохраняет:
   - media_files = ['video:...']
   - message_ids = [message.id]  ← теперь сохраняется!
   ↓
3. AI обрабатывает текст
   ↓
4. PublishingService публикует:
   - _publish_single_message_by_copying
   - copy_messages([message.id])
   - edit_message_caption (добавляет AI-текст)
   ↓
5. Результат: Видео с AI-текстом и гиперссылкой
```

### Для медиа-группы с видео:
```
1. Монитор получает группу (2 фото + 1 видео)
   ↓
2. MessageProcessor сохраняет:
   - media_files = ['photo:...', 'photo:...', 'video:...']
   - message_ids = [218, 219, 220]
   - media_group_id = 14090855242181194
   ↓
3. AI обрабатывает текст
   ↓
4. PublishingService публикует:
   - _publish_media_group_by_copying
   - copy_messages([218, 219, 220])  ← копирует все сразу
   - edit_message_caption на первом
   ↓
5. Результат: Альбом (2 фото + 1 видео) с AI-текстом
```

## Тестирование

### Тест 1: Одиночное видео (Post 38)
```bash
cd "/Users/edgark/CARS BOT"
source venv/bin/activate
source scripts/export_env.sh

# В Python:
python
>>> from cars_bot.tasks.publishing_tasks import publish_post_task
>>> result = publish_post_task.apply_async(args=[38])
>>> print(result.get())
```

### Тест 2: Медиа-группа с видео (Post 35)
```bash
# То же самое для post 35
>>> result = publish_post_task.apply_async(args=[35])
>>> print(result.get())
```

### Ожидаемые логи:
```
# Для одиночного видео
Copying single message 255 from -1001234567890
✓ Single media published (message ID: 456)

# Для медиа-группы
Publishing media group from -1001234567890: 5 messages using copy_messages
✓ Media group copied: 5 messages (first message ID: 789)
✓ Updated caption on first message with AI-generated text
```

## Изменённые файлы

1. ✅ `src/cars_bot/monitor/message_processor.py`
   - Добавлен параметр `message_ids=[message.id]` для одиночных сообщений

2. ✅ `scripts/fix_old_posts_message_ids.py` (новый)
   - Скрипт для исправления старых постов

3. ✅ `scripts/check_video_posts.py` (новый)
   - Скрипт для проверки постов с видео

4. ✅ `scripts/check_specific_posts.py` (новый)
   - Скрипт для проверки конкретных постов

## Результат

✅ **Теперь посты с видео публикуются:**
- ✅ Одиночное видео: copy_messages + AI-текст
- ✅ Медиа-группа с видео: copy_messages всего альбома + AI-текст
- ✅ Гиперссылка "Получить контакты" работает

✅ **Все новые посты сохраняются с message_ids**

✅ **Старые посты исправлены (16 постов)**

