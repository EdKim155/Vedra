# Alembic Database Migrations

This directory contains Alembic database migration scripts for the Cars Bot project.

## Structure

```
alembic/
├── versions/           # Migration files
├── env.py             # Alembic environment configuration (async support)
├── script.py.mako     # Template for new migrations
└── README.md          # This file
```

## Quick Start

### Apply All Migrations

```bash
# Using Makefile
make migrate

# Or directly
python scripts/run_migrations.py upgrade

# Or with alembic CLI
alembic upgrade head
```

### Create New Migration

```bash
# Using Makefile
make migrate-create MESSAGE="add new column to users table"

# Or directly
python scripts/run_migrations.py create "add new column to users table"

# Or with alembic CLI
alembic revision --autogenerate -m "add new column to users table"
```

### Rollback Migration

```bash
# Using Makefile
make migrate-down

# Or directly
python scripts/run_migrations.py downgrade

# Or with alembic CLI
alembic downgrade -1
```

### View Migration History

```bash
# Using Makefile
make migrate-history

# Or directly
python scripts/run_migrations.py history

# Or with alembic CLI
alembic history --verbose
```

### Check Current Revision

```bash
make migrate-current

# Or
python scripts/run_migrations.py current

# Or
alembic current
```

## Environment Variables

The migrations use the `DATABASE_URL` environment variable:

```bash
export DATABASE_URL="postgresql+asyncpg://user:password@localhost:5432/dbname"
```

If not set, it will use the URL from `alembic.ini` (not recommended for production).

## Available Migrations

### 001_initial_migration

**Created:** 2025-10-23
**Revision:** 001

Creates all initial tables:
- channels - Monitored Telegram channels
- posts - Processed posts
- car_data - Structured vehicle data
- seller_contacts - Seller contact information
- users - Bot users
- subscriptions - User subscriptions
- payments - Payment transactions
- contact_requests - Contact access requests
- settings - System settings

Also creates enum types:
- subscription_type (free, monthly, yearly)
- payment_status (pending, completed, failed, refunded)
- payment_provider (yookassa, telegram_stars, mock)
- autoteka_status (green, has_accidents, unknown)
- transmission_type (automatic, manual, robot, variator)

## Best Practices

### Creating Migrations

1. **Always review autogenerated migrations** before applying them
2. **Test migrations locally** before applying to production
3. **Write meaningful messages** when creating migrations
4. **Keep migrations small** - one logical change per migration

### Applying Migrations

1. **Backup database** before applying migrations in production
2. **Test in staging** environment first
3. **Apply during low-traffic** periods
4. **Monitor logs** during migration

### Rollback

1. **Test rollback** before production deployment
2. **Have a backup** before rolling back
3. **Document** why rollback was necessary

## Docker Usage

When using Docker Compose, migrations are automatically applied on startup:

```bash
# The 'migrate' service runs migrations
docker-compose up -d

# Or run migrations manually
docker-compose run --rm migrate

# Or run specific command
docker-compose run --rm bot alembic upgrade head
```

## Troubleshooting

### Migration Fails

1. Check database connection:
   ```bash
   echo $DATABASE_URL
   ```

2. Check current revision:
   ```bash
   make migrate-current
   ```

3. Check migration history:
   ```bash
   make migrate-history
   ```

4. Try running migration manually with verbose output:
   ```bash
   alembic upgrade head --verbose
   ```

### Async Engine Issues

This project uses **async SQLAlchemy**, so:
- Use `postgresql+asyncpg://` in DATABASE_URL (not `postgresql://`)
- Don't use synchronous database operations in migrations
- The `env.py` is configured for async operations

### Conflicting Revisions

If you have conflicting migration heads:

```bash
# Show heads
alembic heads

# Merge heads
alembic merge heads -m "merge conflicting migrations"
```

## Manual Migration Example

```python
"""add user email column

Revision ID: 002
Revises: 001
Create Date: 2025-10-24 10:00:00

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = '002'
down_revision = '001'

def upgrade() -> None:
    op.add_column('users',
        sa.Column('email', sa.String(255), nullable=True,
                  comment='User email address')
    )
    op.create_index('ix_users_email', 'users', ['email'])

def downgrade() -> None:
    op.drop_index('ix_users_email', table_name='users')
    op.drop_column('users', 'email')
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Async Documentation](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- Project: [docs/DATABASE.md](../docs/DATABASE.md)
