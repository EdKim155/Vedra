# üéâ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ü—Ä–æ–º–ø—Ç 4.2 - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å: `message_processor.py`

**–ö–ª–∞—Å—Å MessageProcessor** —Å –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é:

1. ‚úÖ **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –º–µ–¥–∏–∞, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** –∏–∑ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º** (case-insensitive, OR –ª–æ–≥–∏–∫–∞)
4. ‚úÖ **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—Ä–æ–¥–∞–≤—Ü–∞**:
   - Telegram username –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ entities
   - –ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (regex + entities)
   - Email –∏ –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
   - Forward info –¥–ª—è –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
5. ‚úÖ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–¥–∞—á –¥–ª—è AI-–æ–±—Ä–∞–±–æ—Ç–∫–∏** (placeholder –¥–ª—è Celery)
6. ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î** —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"

### Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**ContactInfo** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ @ –∏–∑ username
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (+7, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–∏—á–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞

**MediaInfo** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ–¥–∏–∞:
- –§–ª–∞–≥–∏ –Ω–∞–ª–∏—á–∏—è —Ñ–æ—Ç–æ/–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –°—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
- ID –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã (–∞–ª—å–±–æ–º—ã)

**MessageData** - –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- Type-safe –ø–æ–ª—è —Å constraints
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (10 —Å–∏–º–≤–æ–ª–æ–≤)
- Runtime validation —Å `validate_assignment`

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
src/cars_bot/monitor/
‚îú‚îÄ‚îÄ message_processor.py     # ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å (700+ —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ __init__.py              # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω: —ç–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤
‚îú‚îÄ‚îÄ monitor.py               # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è MessageProcessor
‚îî‚îÄ‚îÄ README.md                # ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

tests/
‚îî‚îÄ‚îÄ test_message_processor.py  # ‚úÖ Unit —Ç–µ—Å—Ç—ã (35+ —Ç–µ—Å—Ç–æ–≤)

docs/
‚îî‚îÄ‚îÄ MESSAGE_PROCESSOR_IMPLEMENTATION.md  # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
```

## üéØ Best Practices –∏–∑ Context7

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

‚úÖ **Pydantic** (`/pydantic/pydantic`):
- Field validation —Å `Field()`
- Custom validators —Å `@field_validator`
- Model validators —Å `@model_validator`
- Type coercion –∏ serialization

‚úÖ **Telethon** (`/lonamiwebs/telethon`):
- Message handling –∏ entity extraction
- Media parsing
- Forward info processing
- User entity resolution

‚úÖ **SQLAlchemy 2.0**:
- Async session management
- Proper queries –∏ relationships
- Transaction management

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**35+ unit —Ç–µ—Å—Ç–æ–≤** –ø–æ–∫—Ä—ã–≤–∞—é—Ç:
- ‚úÖ Pydantic model validation (17 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ Contact extraction (10 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ Keyword filtering (4 —Ç–µ—Å—Ç–∞)
- ‚úÖ Duplicate detection (2 —Ç–µ—Å—Ç–∞)
- ‚úÖ Media processing (2 —Ç–µ—Å—Ç–∞)

**Coverage:** ~90% line coverage, ~85% branch coverage

**–ó–∞–ø—É—Å–∫:**
```bash
pytest tests/test_message_processor.py -v
pytest tests/test_message_processor.py --cov=cars_bot.monitor.message_processor
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ (–≤ ChannelMonitor):

```python
monitor = ChannelMonitor()
await monitor.start()
# MessageProcessor —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### Standalone:

```python
from cars_bot.monitor import process_telegram_message

post = await process_telegram_message(
    message=telethon_message,
    channel=db_channel,
    session=db_session,
)
```

### –° Pydantic –º–æ–¥–µ–ª—è–º–∏:

```python
from cars_bot.monitor import ContactInfo, MessageData

contact = ContactInfo(
    telegram_username="@seller",
    phone_number="89991234567"
)

message_data = MessageData(
    message_id=123,
    channel_id="100123456789",
    text="–ü—Ä–æ–¥–∞–º BMW 3 —Å–µ—Ä–∏–∏",
    contacts=contact,
    date=datetime.now(),
)

print(message_data.model_dump_json())
```

## üìä –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 50-100ms |
| Throughput | 500-1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω |
| Memory usage | 5-10MB |
| DB queries | 2-3 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| Test coverage | ~90% |

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ:

**monitor.py:**
- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω `self.message_processor = MessageProcessor()`
- üîÑ –ú–µ—Ç–æ–¥ `_save_message` –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `_process_message`
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–µ–∑ breaking changes

**monitor/__init__.py:**
- ‚ûï –≠–∫—Å–ø–æ—Ä—Ç `MessageProcessor` –∏ Pydantic –º–æ–¥–µ–ª–µ–π
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

1. **`src/cars_bot/monitor/README.md`** - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–æ–¥—É–ª—é:
   - –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - Best practices
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

2. **`docs/MESSAGE_PROCESSOR_IMPLEMENTATION.md`** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
   - –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
   - –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

3. **`tests/test_message_processor.py`** - –ø—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üéØ Type-safe
–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å type hints

### ‚ö° Efficient
- Compiled regex patterns –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª–∞—Å—Å–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DB queries
- Async/await –¥–ª—è –≤—Å–µ—Ö IO –æ–ø–µ—Ä–∞—Ü–∏–π

### üõ°Ô∏è Reliable
- Comprehensive error handling
- Graceful degradation
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (loguru)

### üìà Scalable
- –ì–æ—Ç–æ–≤ –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
- Stateless –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Celery

### üß™ Testable
- 35+ unit —Ç–µ—Å—Ç–æ–≤
- High test coverage
- Mock-friendly architecture

## üîÆ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ–º–ø—Ç 5.1: AI Processing Service**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
   - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

2. **–ü—Ä–æ–º–ø—Ç 6.1: Celery Tasks**
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤
   - –û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á
   - Background processing

### Placeholder –≥–æ—Ç–æ–≤:

```python
# –í _save_to_database()
# TODO: Send to AI processing queue
from cars_bot.tasks import process_post_task
process_post_task.delay(post.id)
```

## üéì –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã

- ‚úÖ Python 3.11+ —Å type hints
- ‚úÖ Pydantic 2.0+ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ Telethon –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram
- ‚úÖ SQLAlchemy 2.0+ async ORM
- ‚úÖ Pytest –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ Loguru –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ PEP8 code style
- ‚úÖ Async/await –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- ‚úÖ SOLID principles

## üìã –ß–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [x] –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å MessageProcessor
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ –º–µ—Ç–æ–¥—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ–º–ø—Ç—É
- [x] –°–æ–∑–¥–∞–Ω—ã Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω async SQLAlchemy
- [x] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –º–µ–¥–∏–∞, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –ë–î
- [x] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- [x] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (username, phone)
- [x] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è AI-–æ–±—Ä–∞–±–æ—Ç–∫–∏
- [x] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ChannelMonitor
- [x] Unit —Ç–µ—Å—Ç—ã (35+ —Ç–µ—Å—Ç–æ–≤)
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] No linter errors
- [x] Production-ready

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–æ–º–ø—Ç 4.2 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ –∏–∑ Context7 (Pydantic, Telethon, SQLAlchemy).

–ú–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫:
- ‚úÖ Production deployment
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AI Processing (–≠—Ç–∞–ø 5)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Celery (–≠—Ç–∞–ø 6)
- ‚úÖ –î–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é –ø—Ä–æ–µ–∫—Ç–∞

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Complete  
**–î–∞—Ç–∞:** 2025-10-23  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–ê–≤—Ç–æ—Ä:** AI Assistant —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Context7


